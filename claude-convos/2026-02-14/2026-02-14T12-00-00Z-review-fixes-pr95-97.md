# Code Review Fixes for PRs #95, #96, #97

**Date:** 2026-02-14
**Branch:** `fix/review-findings-pr95-97`
**Plan:** `plans/phase-6/subphases/p6-c-01-review-fixes.md`

## Goals

Address 1 HIGH and 5 MEDIUM severity issues identified during Opus code review of PRs #95, #96, #97.

## Key Decisions

1. **Field name harmonization (HIGH):** Added `normalizeInputFieldNames()` to map CalendarEvent names (matching `get_events` output) to Intervals.icu API names. Both old and new conventions accepted for backward compatibility. Schema properties and response shapes now use CalendarEvent conventions.

2. **Event type enum casing:** Schema advertises lowercase enum values (`workout`, `race`, etc.) matching CalendarEvent convention. Internally normalizes to uppercase for the API. Response returns lowercase.

3. **event_id numeric validation (MEDIUM):** Added regex check (`/^\d+$/`) before the API call, plus `encodeURIComponent()` as defense-in-depth.

4. **NOT NULL migration:** Created `007_training_plans_status_not_null.sql` to backfill NULLs and add the constraint. Updated TypeScript types to remove `| null`.

5. **Documentation:** Added JSDoc explaining reserved values in `PERIODIZATION_PHASES` and `TRAINING_FOCUS`. Documented intentional `IntervalsApiError` duplication in test helpers. Fixed JSONB examples to match TypeScript `TrainingPhase` interface.

## Files Changed

### Modified
- `supabase/functions/mcp-gateway/tools/event-validation.ts` — Field mapping, schema, response shape
- `supabase/functions/mcp-gateway/tools/create-event.ts` — Normalization, removed unused const
- `supabase/functions/mcp-gateway/tools/update-event.ts` — Normalization, numeric event_id validation
- `supabase/functions/mcp-gateway/utils/intervals-api.ts` — `encodeURIComponent` on eventId
- `supabase/functions/mcp-gateway/tools/__tests__/event-test-helpers.ts` — Improved JSDoc
- `supabase/functions/mcp-gateway/tools/__tests__/create-event.test.ts` — CalendarEvent field names
- `supabase/functions/mcp-gateway/tools/__tests__/update-event.test.ts` — CalendarEvent names, numeric validation tests
- `supabase/functions/mcp-gateway/tools/__tests__/event-validation.test.ts` — normalizeInputFieldNames tests
- `packages/core/src/types/training.ts` — JSDoc for reserved values
- `packages/supabase-client/src/types.ts` — `status: string` (removed `| null`)
- `supabase/migrations/006_training_plans.sql` — Fixed JSONB example
- `plans/phase-6/subphases/p6-b-01-training-plans-schema.md` — Fixed JSONB example

### Created
- `supabase/migrations/007_training_plans_status_not_null.sql`

## Learnings

- When harmonizing field names across read/write tools, a normalization layer at the handler entry point keeps validation and payload building unchanged.
- Backward compatibility is easy when the normalization maps new names to old (API) names — unmapped keys pass through.
