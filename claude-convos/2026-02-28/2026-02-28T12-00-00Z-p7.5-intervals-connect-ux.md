# Phase 7.5: Intervals.icu Connect Screen UX Improvements

## Date
2026-02-28

## Goals
Implement the full Phase 7.5 plan to transform the Intervals.icu connect screen from a passive credential collector into an active, validated connection flow with proper feedback.

## Tasks Completed

### P7.5-IC-01: Credential Validation in Edge Function
- Added `validateIntervalsCredentials()` to `intervals-api.ts` - fetches athlete profile to validate
- Modified `credentials/index.ts` POST handler to validate before upsert
- Returns appropriate error codes: 401 (invalid creds), 429 (rate limited), 502 (unreachable)
- 7 new tests for validation function

### P7.5-IC-02: "What is Intervals.icu?" Explainer
- Added collapsible explainer section with description of Intervals.icu
- "Create a free account" link opens intervals.icu in device browser
- Credential help text showing where to find Athlete ID and API Key
- Proper accessibility (expandable state, link role)

### P7.5-IC-03: Connect Screen Hook Wiring
- Replaced in-memory-only credential handling with `useIntervalsConnection` hook
- Added loading state (ActivityIndicator, "Connecting..." button text, disabled inputs)
- Added error state (error banner with hook error message)
- Added connected view on re-entry (green checkmark, athlete ID, Change Account/Continue)
- Auto-advance to fitness screen after successful connection (1.5s delay)
- Updates both OnboardingContext and Supabase on connect/disconnect

### P7.5-IC-04: Manual Test Cases
- Added test cases OB-05a through OB-05g to manual-test-cases.csv
- Covers: invalid credentials, loading state, success feedback, re-entry, change account, explainer, sign-up link

## Key Decisions
- Combined IC-02 and IC-03 into a single PR since they both modify `connect.tsx`
- Used athlete profile endpoint (`/api/v1/athlete/{id}`) for credential validation - lightweight and reliable
- Initial hook loading state shows full-screen spinner (vs skeleton) for simplicity
- Connected view is a separate render path (not just a state overlay) for cleaner code

## Files Changed
- `supabase/functions/mcp-gateway/utils/intervals-api.ts` - Added `validateIntervalsCredentials` export
- `supabase/functions/mcp-gateway/utils/__tests__/intervals-api.test.ts` - 7 new validation tests
- `supabase/functions/credentials/index.ts` - Added validation before credential upsert
- `apps/mobile/app/onboarding/connect.tsx` - Complete rewrite with explainer, hook wiring, states
- `apps/mobile/app/onboarding/__tests__/connect.test.tsx` - Rewritten tests for new behavior
- `docs/testing/manual-test-cases.csv` - Added OB-05a through OB-05g
- `plans/phase-7.5/p7.5-intervals-connect-ux.md` - Phase 7.5 plan document

## Learnings
- Jest `fn<>()` generic syntax varies by version - `jest.fn().mockResolvedValue()` is more portable
- Biome auto-fixes formatting issues including function signature line breaks
- `KeyboardAwareScrollView` from `react-native-keyboard-controller` already in use on this screen
- The `useIntervalsConnection` hook starts with `isLoading: true` due to initial `refresh()` call
