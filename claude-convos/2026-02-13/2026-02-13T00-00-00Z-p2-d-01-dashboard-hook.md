# P2-D-01: Create Dashboard Data Hook

## Date
2026-02-13

## Goals
- Create `useDashboard` hook that aggregates data for the dashboard screen
- Wire the dashboard to display real data instead of hardcoded placeholders
- Add comprehensive tests

## Key Decisions

### Hook Architecture
- Single `useDashboard` hook that fetches athlete profile, active goals, and today's check-in in a coordinated flow
- Athlete profile fetched first (needed for athleteId), then goals and check-in fetched in parallel via `Promise.all`
- Returns aggregated `DashboardData` with greeting, recommendations, fitness metrics, and upcoming events

### Type Safety
- Used type guard filter `(g): g is GoalRow & { target_date: string }` to avoid non-null assertions (biome lint)
- Runtime validation for AI recommendation JSON with `parseRecommendation()` - validates field types and defaults invalid intensity to 'moderate'
- Priority field validated against allowed values `['A', 'B', 'C']` before casting

### Dashboard Screen Wiring
- Added loading state, error state with retry, and pull-to-refresh
- Personalized greeting with athlete's first name
- Conditional rendering: check-in prompt vs workout recommendation
- Fitness metrics show FTP when available, CTL/ATL/TSB remain `--` until Phase 3
- Upcoming events from active goals, sorted by date, limited to 5

### Error Surfacing
- Goals/checkin fetch errors are surfaced as `warnings: string[]` in `DashboardData` instead of being silently swallowed
- Allows UI to distinguish "no data" from "failed to load"

### Naming Convention Decision
- `parseRecommendation()` expects camelCase (`workoutSuggestion`, `summary`, `intensityLevel`, `duration`)
- This aligns with the ai-client's `WorkoutRecommendation` type (the canonical producer)
- Integration tests with snake_case data are the outlier — fix tracked in PR #49

### Testing Strategy
- 29 hook tests covering: loading, data fetch, greeting personalization, fitness metrics, check-in/recommendation parsing, upcoming events, error handling (including warnings), auth/supabase unavailability, refresh
- 13 screen tests updated to mock `useDashboard` (previously tested hardcoded UI)

## Files Changed
- `apps/mobile/hooks/useDashboard.ts` (created) - Main hook
- `apps/mobile/hooks/__tests__/useDashboard.test.ts` (created) - 25 tests
- `apps/mobile/hooks/index.ts` (modified) - Added export
- `apps/mobile/app/(tabs)/index.tsx` (modified) - Wired to use hook
- `apps/mobile/app/(tabs)/__tests__/index.test.tsx` (modified) - Updated tests

## Learnings
- `getActiveGoals` already existed in supabase-client, no new query needed
- Biome enforces no non-null assertions; type guard filters are the clean alternative
- Biome formatter preferences: single-line filter predicates when they fit, no unnecessary parentheses around ternary expressions
- `ai_recommendation` JSON column has inconsistent naming across codebase — standardized on camelCase (matches AI client producer)
- SonarCloud cognitive complexity: extract sub-components to stay under limit of 15
- JSX `{value}W` renders as two children — use template literal `{`${value}W`}` for single string
