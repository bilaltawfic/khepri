name: Claude Convos Check

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-claude-convos:
    name: Check AI Conversation Logging
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for claude-convos update
        id: check-convos
        run: |
          # Check if claude-convos was updated in this PR
          CONVOS_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.sha }} | grep -c "^claude-convos/" || true)

          if [ "$CONVOS_CHANGED" -gt 0 ]; then
            echo "convos_updated=true" >> $GITHUB_OUTPUT
            echo "✅ Claude conversation log found in PR"
          else
            echo "convos_updated=false" >> $GITHUB_OUTPUT
            echo "⚠️ No claude-convos update found"
          fi

      - name: Comment on PR if missing
        if: steps.check-convos.outputs.convos_updated == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              "## ❌ Conversation Log Required",
              "",
              "This PR is missing an update to `claude-convos/`.",
              "",
              "**Please log your conversation:**",
              "",
              "1. Create a file: `claude-convos/YYYY-MM-DD/YYYY-MM-DDTHH-MM-SSZ-short-description.md`",
              "2. Include: goals, key decisions, files changed, and learnings",
              `3. See [CONTRIBUTING.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md#ai-conversation-logging) for the template`,
              "",
              "**Tip:** Use `/log-convo <description>` in Claude Code to generate the log automatically.",
              "",
              "---",
              "*This project requires AI transparency for all PRs.*",
            ].join("\n");

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              (c.body.includes('Conversation Log Required') || c.body.includes('AI Conversation Log Reminder'))
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if conversation log missing
        if: steps.check-convos.outputs.convos_updated == 'false'
        run: |
          echo "❌ This PR is missing a claude-convos update."
          echo "Please log your conversation before merging."
          echo "Tip: Use '/log-convo <description>' in Claude Code to generate the log."
          exit 1
