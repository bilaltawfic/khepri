name: Claude Convos Check

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-claude-convos:
    name: Check AI Conversation Logging
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            apps/**
            packages/**
            supabase/**
          files_ignore: |
            **/*.md
            **/tsconfig.json
            **/app.json
            **/eas.json
            **/.gitkeep

      - name: Check for claude-convos update
        id: check-convos
        run: |
          # Check if any significant code changes were made
          if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
            echo "significant_changes=true" >> $GITHUB_OUTPUT

            # Check if claude-convos was updated in this PR
            CONVOS_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.sha }} | grep -c "^claude-convos/" || true)

            if [ "$CONVOS_CHANGED" -gt 0 ]; then
              echo "convos_updated=true" >> $GITHUB_OUTPUT
              echo "✅ Claude conversation log found in PR"
            else
              echo "convos_updated=false" >> $GITHUB_OUTPUT
              echo "⚠️ No claude-convos update found"
            fi
          else
            echo "significant_changes=false" >> $GITHUB_OUTPUT
            echo "No significant code changes detected"
          fi

      - name: Comment on PR if missing
        if: steps.check-convos.outputs.significant_changes == 'true' && steps.check-convos.outputs.convos_updated == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              "## ❌ AI Conversation Log Required",
              "",
              "This PR contains significant code changes but no update to `claude-convos/`.",
              "",
              "**Please log your AI conversation:**",
              "",
              "1. Create a file: `claude-convos/YYYY-MM-DD/YYYY-MM-DDTHH-MM-SSZ-short-description.md`",
              "2. Include: goals, key decisions, files changed, and learnings",
              `3. See [CONTRIBUTING.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md#ai-conversation-logging) for the template`,
              "",
              "---",
              "*This check enforces AI transparency. All AI-assisted code changes require conversation logging.*",
            ].join("\n");

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('AI Conversation Log')
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if conversation log missing
        if: steps.check-convos.outputs.significant_changes == 'true' && steps.check-convos.outputs.convos_updated == 'false'
        run: |
          echo "❌ This PR has significant code changes but no claude-convos update."
          echo "Please log your AI conversation before merging."
          exit 1
