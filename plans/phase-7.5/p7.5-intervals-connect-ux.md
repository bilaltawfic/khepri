# Phase 7.5: Intervals.icu Connect Screen UX Improvements

## Goal

Transform the Intervals.icu connect screen from a passive credential collector into an active, validated connection flow with proper feedback. Users should know immediately whether their credentials work, understand what Intervals.icu is if they don't have an account, and see clear connection state when returning to the screen.

**Discovered during:** OB-05 manual testing
**Branch strategy:** Create `fix/p7.5-intervals-connect-ux` from `fix/p7.5-test-ob`, PR back into `fix/p7.5-test-ob`

---

## Current State

The connect screen (`apps/mobile/app/onboarding/connect.tsx`) currently:
- Collects Athlete ID and API Key into `OnboardingContext` (in-memory only)
- Does **no validation** against the Intervals.icu API — credentials are stored blindly
- Shows no loading, success, or error states
- On re-entry (navigate back), pre-populates fields but shows no "connected" indicator
- Assumes users know what Intervals.icu is

The infrastructure for validation **already exists**:
- `supabase/functions/credentials/index.ts` — encrypts and stores credentials (POST)
- `apps/mobile/hooks/useIntervalsConnection.ts` — `connect()`, `disconnect()`, `refresh()` with loading/error state
- `apps/mobile/services/credentials.ts` — `saveCredentials()`, `getConnectionStatus()`, `deleteCredentials()`
- `supabase/functions/mcp-gateway/utils/intervals-api.ts` — API calls with proper error handling (401/403 → `INVALID_CREDENTIALS`)

**Gap:** The credentials edge function saves credentials without validating them against the Intervals.icu API first. The connect screen doesn't use `useIntervalsConnection` hook at all.

---

## Tasks (4 PRs)

### P7.5-IC-01: Add credential validation to the credentials edge function

**Branch:** `fix/p7.5-ic-01-validate-credentials`
**Estimated scope:** ~80 lines changed

**Modify files:**
- `supabase/functions/credentials/index.ts` — Add validation call before upsert
- `supabase/functions/credentials/index.test.ts` — Add validation tests (create if needed)

**Changes:**
1. In the POST handler, **before** the upsert, validate credentials against the Intervals.icu API
2. Use a lightweight API call — fetch today's wellness data (single day range) or the athlete profile
3. If credentials are invalid (401/403), return a `401` with a clear error message: `"Invalid Intervals.icu credentials. Please check your Athlete ID and API Key."`
4. If Intervals.icu is unreachable (network error, 5xx), return a `502` with: `"Could not reach Intervals.icu to verify credentials. Please try again."`
5. If rate limited (429), return a `429` with: `"Intervals.icu rate limit reached. Please wait a moment and try again."`
6. Only proceed with upsert if validation succeeds

**Validation approach:**
```typescript
// In POST handler, after input validation but before upsert:
const credentials = {
  intervalsAthleteId: intervals_athlete_id.trim(),
  apiKey: api_key,
};

// Import and call validation function
try {
  await validateIntervalsCredentials(credentials);
} catch (err) {
  if (err instanceof IntervalsApiError) {
    if (err.code === 'INVALID_CREDENTIALS') {
      return errorResponse('Invalid Intervals.icu credentials. Please check your Athlete ID and API Key.', 401);
    }
    if (err.code === 'RATE_LIMITED') {
      return errorResponse('Intervals.icu rate limit reached. Please wait a moment and try again.', 429);
    }
  }
  return errorResponse('Could not reach Intervals.icu to verify credentials. Please try again.', 502);
}
```

**Validation function** (add to `intervals-api.ts` or inline):
```typescript
// Fetch athlete profile or wellness for a single day to validate creds
async function validateIntervalsCredentials(credentials: IntervalsCredentials): Promise<void> {
  const url = `${INTERVALS_BASE_URL}/athlete/${credentials.intervalsAthleteId}`;
  const response = await fetch(url, {
    headers: { Authorization: authHeader(credentials) },
  });
  if (!response.ok) {
    await handleErrorResponse(response);
  }
}
```

**Tests:**
- Valid credentials → 200, credentials saved
- Invalid credentials (401) → 401 returned, nothing saved
- Intervals.icu down → 502 returned, nothing saved
- Rate limited → 429 returned, nothing saved

**Deps:** None

---

### P7.5-IC-02: Add "What is Intervals.icu?" explainer and sign-up link

**Branch:** `fix/p7.5-ic-02-intervals-explainer`
**Estimated scope:** ~100 lines changed

**Modify files:**
- `apps/mobile/app/onboarding/connect.tsx` — Add explainer section and external link
- `apps/mobile/app/onboarding/__tests__/connect.test.tsx` — Add tests for new UI elements

**Changes:**
1. Add an expandable/collapsible "What is Intervals.icu?" section below the description
2. Explain what Intervals.icu is in 2-3 sentences: a free training analytics platform that tracks fitness, fatigue, and form from Garmin/Strava/Wahoo data
3. Add a "Create a free account" link that opens `https://intervals.icu` in the device browser via `Linking.openURL()`
4. Add helper text: "After creating your account, come back here to connect it"
5. Show where to find the Athlete ID (URL bar) and API Key (Settings > Developer Settings > API Key)

**UI layout:**
```
[Existing title and description]

[Expandable: "What is Intervals.icu?"]
  Intervals.icu is a free training analytics platform for endurance
  athletes. It syncs with Garmin, Strava, and Wahoo to track your
  fitness (CTL), fatigue (ATL), and form (TSB).

  [Create a free account →]  (opens browser)

  After creating your account, come back here to connect.

[Where to find your credentials]
  • Athlete ID: Found in your Intervals.icu URL (e.g., intervals.icu/athlete/i12345)
  • API Key: Go to Settings > Developer Settings > API Key

[Existing input fields and buttons]
```

**Accessibility:**
- `accessibilityRole="link"` on the external link
- Expandable section uses `accessibilityState={{ expanded }}`

**Tests:**
- Explainer section renders and is expandable
- "Create a free account" link triggers `Linking.openURL` with correct URL
- Credential help text renders

**Deps:** None (can run in parallel with IC-01)

---

### P7.5-IC-03: Wire connect screen to useIntervalsConnection hook with loading/error/success states

**Branch:** `fix/p7.5-ic-03-connect-screen-states`
**Estimated scope:** ~150 lines changed

**Modify files:**
- `apps/mobile/app/onboarding/connect.tsx` — Use `useIntervalsConnection` hook, add state UI
- `apps/mobile/app/onboarding/__tests__/connect.test.tsx` — Add loading/error/success tests

**Changes:**

1. **Import and use `useIntervalsConnection` hook** for actual credential saving + validation
2. **Loading state**: When "Connect Account" is pressed, show an `ActivityIndicator` and disable inputs. Button text changes to "Connecting..."
3. **Success state**: On successful connection, show a success banner (green checkmark + "Connected as {athleteId}"). Transition to "connected view" (see #4). Auto-advance to next screen after 1.5s, or user can tap "Continue"
4. **Connected view (re-entry)**: When navigating back to this screen and credentials are already saved:
   - Show "Connected to Intervals.icu" with a green checkmark
   - Show the Athlete ID (masked API key)
   - Show "Change Account" button (clears credentials, returns to input view)
   - Show "Continue" button to proceed
5. **Error state**: On failure, show an error banner (red) with the server error message. Keep inputs editable for retry. Don't navigate away.
6. **"Connect Account" → calls `useIntervalsConnection.connect()`** which:
   - Saves credentials to Supabase (encrypted)
   - Server validates against Intervals.icu API (from IC-01)
   - Returns success or error

**State machine:**
```
IDLE (no credentials) → [user fills fields] → READY
READY → [tap Connect] → CONNECTING (loading)
CONNECTING → success → CONNECTED (show success, auto-advance)
CONNECTING → error → ERROR (show error, stay on screen)
CONNECTED → [navigate back] → CONNECTED (show connected view)
CONNECTED → [tap Change Account] → IDLE
```

**Key consideration:** The `OnboardingContext` still stores credentials in memory for the onboarding flow. The `useIntervalsConnection` hook also saves to Supabase. Both should be updated:
- On connect success: update both context and Supabase
- On "Change Account": clear both context and Supabase credentials

**Tests:**
- Loading state shows ActivityIndicator when connecting
- Success state shows connected banner with athlete ID
- Error state shows error message and allows retry
- Re-entry shows connected view with Change Account option
- Change Account clears credentials and returns to input view
- Skip clears credentials from both context and Supabase

**Deps:** P7.5-IC-01 (server-side validation must be in place)

---

### P7.5-IC-04: Add new manual test cases for Intervals.icu connect UX

**Branch:** `fix/p7.5-ic-04-test-cases`
**Estimated scope:** ~30 lines changed

**Modify files:**
- `docs/testing/manual-test-cases.csv` — Add test cases OB-05a through OB-05g after OB-05

**New test cases:**

| ID | Category | Use Case | Preconditions | Steps | Expected Result |
|----|----------|----------|---------------|-------|-----------------|
| OB-05a | Onboarding | Intervals.icu connection - invalid credentials | On connect screen | 1. Enter invalid Athlete ID (e.g. "fake123") 2. Enter invalid API Key (e.g. "badkey") 3. Tap 'Connect' | Loading spinner shown. Error message displayed: "Invalid Intervals.icu credentials." Inputs remain editable for retry. |
| OB-05b | Onboarding | Intervals.icu connection - loading state | On connect screen with valid credentials | 1. Enter valid credentials 2. Tap 'Connect' 3. Observe during connection | Button shows "Connecting..." with spinner. Inputs are disabled. Cannot tap Connect again. |
| OB-05c | Onboarding | Intervals.icu connection - success feedback | On connect screen, connection succeeds | 1. After OB-05 passes | Success banner shown with green checkmark and "Connected as {athleteId}". Auto-advances to fitness screen after brief delay. |
| OB-05d | Onboarding | Intervals.icu connection - re-entry after connecting | Already connected in OB-05 | 1. Navigate back to connect screen from fitness screen | Shows "Connected to Intervals.icu" with athlete ID. "Change Account" and "Continue" buttons visible. Input fields hidden. |
| OB-05e | Onboarding | Intervals.icu connection - change account | On connect screen showing connected state | 1. Tap "Change Account" | Returns to input view. Fields are empty. Previous credentials cleared. Can enter new credentials. |
| OB-05f | Onboarding | "What is Intervals.icu?" explainer | On connect screen | 1. Tap "What is Intervals.icu?" section | Expandable section shows explanation of Intervals.icu. "Create a free account" link visible. Credential help text shown. |
| OB-05g | Onboarding | "Create a free account" link | On connect screen, explainer expanded | 1. Tap "Create a free account" | Opens intervals.icu in device browser. User can create account and return to app. |

**Deps:** None (can be done first or in parallel)

---

## Dependencies

```
P7.5-IC-01 ──────┐
                  ├──→ P7.5-IC-03 (needs server validation)
P7.5-IC-02 ──────┘         │
                            │  (IC-02 merges into connect.tsx independently,
                            │   IC-03 builds on the merged result)
P7.5-IC-04 ──── (independent, do first or in parallel)
```

- **IC-01** and **IC-02** can run in parallel (different files)
- **IC-04** is independent (CSV only)
- **IC-03** depends on IC-01 (server validation) and should be done after IC-02 is merged (same file)

**Recommended order:** IC-04 → IC-01 + IC-02 (parallel) → IC-03

---

## Key Files Reference

| Purpose | File Path |
|---------|-----------|
| Connect screen UI | `apps/mobile/app/onboarding/connect.tsx` |
| Connect screen tests | `apps/mobile/app/onboarding/__tests__/connect.test.tsx` |
| Onboarding context | `apps/mobile/contexts/OnboardingContext.tsx` |
| Credentials edge function | `supabase/functions/credentials/index.ts` |
| Intervals.icu API utils | `supabase/functions/mcp-gateway/utils/intervals-api.ts` |
| Credentials service (mobile) | `apps/mobile/services/credentials.ts` |
| Connection hook | `apps/mobile/hooks/useIntervalsConnection.ts` |
| Manual test cases | `docs/testing/manual-test-cases.csv` |

---

## Testing Approach

- **Unit tests** for credential validation in edge function (mock fetch to Intervals.icu)
- **Component tests** for connect screen states (mock `useIntervalsConnection` hook)
- **No real API calls in tests** — mock all external services
- **Manual test cases** OB-05a through OB-05g cover the full UX flow

---

## Verification

After all 4 PRs merged into `fix/p7.5-test-ob`:
1. Fresh signup → onboarding → connect screen shows explainer and inputs
2. Enter invalid credentials → error shown, can retry
3. Enter valid credentials → loading → success → auto-advances
4. Navigate back → connected view with Change Account option
5. Skip → clears any saved credentials
6. Run `pnpm test`, `pnpm lint`, `pnpm typecheck`, `pnpm build` — all pass
